name: Briefing Bot (AAPL)

on:
  schedule:
    # KST 07:00 -> UTC 22:00 (Previous Day)
    - cron: '0 22 * * *'
    # KST 19:00 -> UTC 10:00
    - cron: '0 10 * * *'
  workflow_dispatch:
    inputs:
      ticker:
        description: 'Target Stock Ticker'
        required: false
        default: 'AAPL'

jobs:
  run-briefing:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Dependencies
      # keyring 사용을 위해 keyrings.alt 필수
      run: |
        python -m pip install --upgrade pip
        pip install langchain langchain-anthropic langchain-google-genai google-generativeai langchain-community tiingo finnhub yahooquery pandas keyring keyrings.alt beautifulsoup4 requests

    - name: Setup Keyring
      # Secrets 값을 가져와 keyring에 저장 (Linux Headless 환경용)
      # briefing-bot.py는 keyring.get_password("...", "noriskfullpush")를 사용하므로 이에 맞춰 설정
      run: |
        # Tiingo
        printf "${{ secrets.TIINGO_API_KEY }}" | keyring set tiingo noriskfullpush
        
        # Claude (Anthropic)
        printf "${{ secrets.CLAUD_API_KEY }}" | keyring set claude_quant_automation noriskfullpush
        
        # Gemini (Optional - if used in future)
        printf "${{ secrets.GEMINI_API_KEY }}" | keyring set gemini_quant_automation noriskfullpush
        
        # Slack Webhook
        printf "${{ secrets.SLACK_WEBHOOK_URL }}" | keyring set slack_webhook_url noriskfullpush

    - name: Run Briefing Bot
      # 기본적으로 keyring 백엔드가 keyrings.alt.file.PlaintextKeyring 등을 사용하도록 될 것임
      run: |
        export PYTHONUNBUFFERED=1
        TICKER="${{ inputs.ticker }}"
        if [ -z "$TICKER" ]; then
          TICKER="AAPL"
        fi
        echo "Running briefing for ticker: $TICKER"
        python workspace/1-langraph-bot-fundamental-vs-price/briefing-bot.py "$TICKER"
